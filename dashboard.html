<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Di√°rio de Classe ‚Äì SERP UFF</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 24px;
}

.container {
  max-width: 1200px;
  margin: auto;
}

h2 {
  color: #003366;
  margin-bottom: 10px;
}

.info-box {
  background: #e6f0fa;
  border-left: 6px solid #00509e;
  padding: 14px;
  border-radius: 6px;
  margin-bottom: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.filters {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
}

select {
  padding: 8px;
  font-size: 0.95rem;
}

.table-wrapper {
  overflow-x: auto;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
}

table {
  border-collapse: collapse;
  width: 100%;
  min-width: 1000px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 0.85rem;
  text-align: center;
}

th {
  background: #003366;
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 2;
}

td.nome {
  text-align: left;
  font-weight: bold;
  background: #f7f9fc;
  position: sticky;
  left: 0;
  z-index: 2;
}

td.matricula {
  text-align: left;
  background: #f7f9fc;
  position: sticky;
  left: 200px; /* ajusta conforme largura do nome */
  z-index: 1;
}

/* Status visual */
.confirmada {
  background: #d4edda;
}

.Fora\ do\ raio {
  background: #f8d7da;
}

.Email\ invalido {
  background: #fff3cd;
}

.Duplicada {
  background: #e2e3e5;
}

.legenda {
  margin-top: 14px;
  font-size: 0.85rem;
}
</style>
</head>

<body>

<div class="container">

  <h2>Di√°rio de Classe</h2>

  <div class="info-box" id="infoTurma"></div>

  <div class="filters">
    <select id="filtroMes"></select>
    <select id="filtroModulo"></select>
  </div>

  <div class="table-wrapper">
    <table id="tabelaDiario"></table>
  </div>

  <div class="legenda">
    <strong>Legenda:</strong>
    ‚úÖ Confirmada &nbsp;&nbsp;
    ‚ùå Fora do raio &nbsp;&nbsp;
    ‚ö†Ô∏è Email inv√°lido &nbsp;&nbsp;
    üîÅ Duplicada
  </div>

</div>

<script>
// ==============================
// 1. Dados vindos do workflow 3
// ==============================

const dashboard = JSON.parse(sessionStorage.getItem("dashboard"));
const semestreAtual = sessionStorage.getItem("semestre");
const professor = JSON.parse(sessionStorage.getItem("professor"));

if (!dashboard || !dashboard.diario_classe) {
  alert("Sess√£o expirada ou dados indispon√≠veis.");
  window.location.href = "index.html";
}

const diario = dashboard.diario_classe;

// ==============================
// 2. Helpers
// ==============================

const unico = arr => [...new Set(arr)];
const ordenarTexto = arr => arr.sort((a,b) => a.localeCompare(b));
const extrairMes = data => data.split("/")[1];

// ==============================
// 3. Informa√ß√µes da turma + professor
// ==============================

document.getElementById("infoTurma").innerHTML = `
  <strong>Professor(a):</strong> ${professor.nome} (Matr√≠cula: ${professor.matricula})<br>
  <strong>Disciplina:</strong> ${diario[0].disciplina}<br>
  <strong>M√≥dulo:</strong> ${diario[0].modulo}
`;

// ==============================
// 4. Prepara√ß√£o de filtros
// ==============================

const selMes = document.getElementById("filtroMes");
const selModulo = document.getElementById("filtroModulo");

const mesesNome = [
  "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho",
  "Agosto","Setembro","Outubro","Novembro","Dezembro"
];

// Limites do semestre
let inicioMes = 1, fimMes = 7;
if (semestreAtual && semestreAtual.endsWith("_2")) {
  inicioMes = 7;
  fimMes = 12;
}

// Meses dispon√≠veis
const mesesDisponiveis = ordenarTexto(
  unico(diario.map(d => extrairMes(d.data))).filter(m => Number(m) >= inicioMes && Number(m) <= fimMes)
);

// Preenche select de meses
selMes.innerHTML =
  `<option value="">Todos os meses</option>` +
  mesesDisponiveis
    .map(m => `<option value="${m}">${mesesNome[Number(m) - 1]}</option>`)
    .join("");

// M√≥dulos existentes
const modulos = unico(diario.map(d => d.modulo));
selModulo.innerHTML =
  `<option value="">Todos os m√≥dulos</option>` +
  modulos.map(m => `<option value="${m}">${m}</option>`).join("");

selMes.addEventListener("change", renderizar);
selModulo.addEventListener("change", renderizar);

// ==============================
// 5. Renderiza√ß√£o do Di√°rio com matr√≠cula, total por aluno e linha final
// ==============================

function renderizar() {
  const mesSelecionado = selMes.value;
  const moduloSelecionado = selModulo.value;

  const filtrado = diario.filter(d => {
    const mes = extrairMes(d.data);
    return (
      (!selMes.value || mes === selMes.value) &&
      (!selModulo.value || d.modulo === selModulo.value) &&
      Number(mes) >= inicioMes &&
      Number(mes) <= fimMes
    );
  });

  const alunos = ordenarTexto(unico(filtrado.map(d => d.aluno)));
  const dias = unico(filtrado.map(d => d.data.split("/")[0]))
                  .sort((a,b) => Number(a) - Number(b));

  const totalDias = Math.max(...alunos.map(aluno => filtrado.filter(r => r.aluno === aluno).length));

  const tabela = document.getElementById("tabelaDiario");

  // Cabe√ßalho
  let html = `
    <tr>
      <th>Aluno</th>
      <th>Matr√≠cula</th>
      ${dias.map(d => `<th>${d}</th>`).join("")}
      <th>Total</th>
    </tr>
  `;

  // Linhas por aluno
  alunos.forEach(aluno => {
    html += `<tr><td class="nome">${aluno}</td>`;

    const matricula = filtrado.find(r => r.aluno === aluno)?.matricula || "-";
    html += `<td class="matricula">${matricula}</td>`;

    let totalConfirmadas = 0;

    dias.forEach(dia => {
      const registro = filtrado.find(r =>
        r.aluno === aluno &&
        r.data.split("/")[0] === dia
      );

      if (!registro) {
        html += `<td>-</td>`;
      } else {
        if (registro.presenca) totalConfirmadas++;
        html += `
          <td class="${registro.motivo || 'confirmada'}">
            ${registro.presenca ? "‚úÖ" :
              registro.motivo === "Fora do raio" ? "‚ùå" :
              registro.motivo === "Email invalido" ? "‚ö†Ô∏è" :
              "üîÅ"}
          </td>
        `;
      }
    });

    const percentual = ((totalConfirmadas / totalDias) * 100).toFixed(1);
    html += `<td>${totalConfirmadas} ‚úÖ (${percentual}%)</td>`;

    html += `</tr>`;
  });

  // Linha final: total de presen√ßas por dia
  html += `<tr><td class="nome"><strong>Total ‚úÖ</strong></td><td></td>`;
  dias.forEach(dia => {
    const totalDia = filtrado.filter(r => r.data.split("/")[0] === dia && r.presenca).length;
    html += `<td><strong>${totalDia}</strong></td>`;
  });
  html += `<td>-</td>`; // coluna total n√£o precisa somar percentual
  html += `</tr>`;

  tabela.innerHTML = html;
}

// ==============================
// 6. Primeira renderiza√ß√£o
// ==============================

renderizar();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Di√°rio de Classe ‚Äì SERP UFF</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, Helvetica, sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 24px;
}

.container {
  max-width: 1200px;
  margin: auto;
}

h2 {
  color: #003366;
  margin-bottom: 10px;
}

.info-box {
  background: #e6f0fa;
  border-left: 6px solid #00509e;
  padding: 14px 20px;
  border-radius: 6px;
  margin-bottom: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.info-text {
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 6px;
  font-size: 0.95rem;
}

.info-line {
  display: flex;
  gap: 6px;
  align-items: center;
}

.info-line strong {
  min-width: 90px;
  text-align: left;
  font-weight: bold;
}

.filters {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

select {
  padding: 8px;
  font-size: 0.95rem;
}

.table-wrapper {
  overflow-x: auto;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
}

table {
  border-collapse: collapse;
  width: 100%;
  min-width: 1000px;
}

th, td {
  border: 1px solid #ddd;
  padding: 6px;
  font-size: 0.85rem;
  text-align: center;
}

th {
  background: #003366;
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 2;
}

td.nome {
  text-align: left;
  font-weight: bold;
  background: #f7f9fc;
  position: sticky;
  left: 0;
  z-index: 2;
}

td.matricula {
  background: #f7f9fc;
  position: sticky;
  left: 200px;
  z-index: 1;
}

/* Status visual */
.confirmada { background: #d4edda; }
.Fora\ do\ raio { background: #f8d7da; }
.Email\ invalido { background: #fff3cd; }
.Duplicada { background: #e2e3e5; }

/* Destaques especiais */
td.total, th.total { background: #e0f0ff; font-weight: bold; }
tr.total-linha { background: #f0f4f8; font-weight: bold; }

.legenda {
  margin-top: 14px;
  font-size: 0.85rem;
}

/* Logo proporcional ao texto */
.info-box img {
  height: auto;
  max-height: 100px;
  object-fit: contain;
}

/* Gr√°ficos */
#grafico-container {
  display: flex;
  flex-direction: column;
  gap: 30px;
  margin-top: 30px;
}

#grafico-linha-wrapper {
  width: 100%;
}

#grafico-secundario-wrapper {
  display: flex;
  gap: 20px;
  justify-content: flex-start;
}

#grafico-pizza, #grafico-barra {
  width: 40%;
  height: 250px; /* altura fixa proporcional */
}
</style>
</head>

<body>

<div class="container">

  <h2>SERP - Di√°rio de Classe</h2>

  <div class="info-box">
    <div class="info-text" id="infoTurma"></div>
    <img src="logo-uff.png" alt="Logo UFF">
  </div>

  <div class="filters">
    <select id="filtroMes"></select>
    <select id="filtroModulo"></select>
  </div>

  <div class="table-wrapper">
    <table id="tabelaDiario"></table>
  </div>

  <div id="grafico-container">
    <div id="grafico-linha-wrapper">
      <canvas id="graficoLinha" width="1200" height="300"></canvas>
    </div>
    <div id="grafico-secundario-wrapper">
      <canvas id="graficoPizza"></canvas>
      <canvas id="graficoBarra"></canvas>
    </div>
  </div>

  <div class="legenda">
    <strong>Legenda:</strong>
    ‚úÖ Confirmada &nbsp;&nbsp;
    ‚ùå Fora do raio &nbsp;&nbsp;
    ‚ö†Ô∏è Email inv√°lido &nbsp;&nbsp;
    üîÅ Duplicada
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ==============================
// 1. Dados e semestre
// ==============================

const dashboard = JSON.parse(sessionStorage.getItem("dashboard"));
const semestreAtual = sessionStorage.getItem("semestre");
const professor = JSON.parse(sessionStorage.getItem("professor"));

if (!dashboard || !dashboard.diario_classe) {
  alert("Sess√£o expirada ou dados indispon√≠veis.");
  window.location.href = "index.html";
}

const diario = dashboard.diario_classe;

// ==============================
// 2. Helpers
// ==============================

const unico = arr => [...new Set(arr)];
const ordenarTexto = arr => arr.sort((a,b) => a.localeCompare(b));
const extrairMes = data => data.split("/")[1];

// ==============================
// 3. Informa√ß√µes da turma + professor
// ==============================

const infoTurma = document.getElementById("infoTurma");
infoTurma.innerHTML = `
  <div class="info-line"><strong>Professor(a):</strong> <span>${professor.nome}</span></div>
  <div class="info-line"><strong>Matr√≠cula:</strong> <span>${professor.matricula}</span></div>
  <div class="info-line"><strong>Disciplina:</strong> <span>${diario[0].disciplina}</span></div>
`;

// ==============================
// 4. Prepara√ß√£o de filtros
// ==============================

const selMes = document.getElementById("filtroMes");
const selModulo = document.getElementById("filtroModulo");

const mesesNome = [
  "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho",
  "Agosto","Setembro","Outubro","Novembro","Dezembro"
];

let inicioMes = 1, fimMes = 7;
if (semestreAtual && semestreAtual.endsWith("_2")) {
  inicioMes = 7;
  fimMes = 12;
}

const mesesDisponiveis = ordenarTexto(
  unico(diario.map(d => extrairMes(d.data))).filter(m => Number(m) >= inicioMes && Number(m) <= fimMes)
);

selMes.innerHTML =
  `<option value="">Todos os meses</option>` +
  mesesDisponiveis
    .map(m => `<option value="${m}">${mesesNome[Number(m) - 1]}</option>`)
    .join("");

const modulos = unico(diario.map(d => d.modulo));
selModulo.innerHTML =
  `<option value="">Todos os m√≥dulos</option>` +
  modulos.map(m => `<option value="${m}">${m}</option>`).join("");

selMes.addEventListener("change", renderizar);
selModulo.addEventListener("change", renderizar);

// ==============================
// 5. Renderiza√ß√£o do Di√°rio
// ==============================

function renderizar() {
  const mesSelecionado = selMes.value;
  const moduloSelecionado = selModulo.value;

  const filtrado = diario.filter(d => {
    const mes = extrairMes(d.data);
    return (
      (!selMes.value || mes === selMes.value) &&
      (!selModulo.value || d.modulo === selModulo.value) &&
      Number(mes) >= inicioMes &&
      Number(mes) <= fimMes
    );
  });

  const alunos = ordenarTexto(unico(filtrado.map(d => d.aluno)));
  const dias = unico(filtrado.map(d => d.data.split("/")[0]))
                  .sort((a,b) => Number(a) - Number(b));

  const totalDias = Math.max(...alunos.map(aluno => filtrado.filter(r => r.aluno === aluno).length));

  const tabela = document.getElementById("tabelaDiario");

  let html = `
    <tr>
      <th>Aluno</th>
      <th>Matr√≠cula</th>
      ${dias.map(d => `<th>${d}</th>`).join("")}
      <th class="total">Total</th>
    </tr>
  `;

  alunos.forEach(aluno => {
    html += `<tr><td class="nome">${aluno}</td>`;
    const matricula = filtrado.find(r => r.aluno === aluno)?.matricula || "-";
    html += `<td class="matricula">${matricula}</td>`;

    let totalConfirmadas = 0;

    dias.forEach(dia => {
      const registro = filtrado.find(r =>
        r.aluno === aluno &&
        r.data.split("/")[0] === dia
      );
      if (!registro) html += `<td>-</td>`;
      else {
        if (registro.presenca) totalConfirmadas++;
        html += `
          <td class="${registro.motivo || 'confirmada'}">
            ${registro.presenca ? "‚úÖ" :
              registro.motivo === "Fora do raio" ? "‚ùå" :
              registro.motivo === "Email invalido" ? "‚ö†Ô∏è" :
              "üîÅ"}
          </td>
        `;
      }
    });

    const percentual = ((totalConfirmadas / totalDias) * 100).toFixed(1);
    html += `<td class="total">${totalConfirmadas} ‚úÖ (${percentual}%)</td>`;
    html += `</tr>`;
  });

  html += `<tr class="total-linha"><td class="nome">Total ‚úÖ</td><td></td>`;
  dias.forEach(dia => {
    const totalDia = filtrado.filter(r => r.data.split("/")[0] === dia && r.presenca).length;
    html += `<td class="total">${totalDia}</td>`;
  });
  html += `<td class="total"></td></tr>`;

  tabela.innerHTML = html;

  // ==============================
  // Gr√°ficos
  // ==============================

  const statusMap = { confirmada: "Presen√ßa", "Fora do raio": "Fora do raio", "Email invalido": "Email inv√°lido", Duplicada: "Duplicada" };

  // Linha: evolu√ß√£o de presen√ßas
  const diasOrdenados = dias;
  const presencaPorDia = diasOrdenados.map(d => filtrado.filter(r => r.data.split("/")[0]===d && r.presenca).length);

  const ctxLinha = document.getElementById("graficoLinha").getContext("2d");
  if (window.chartLinha) window.chartLinha.destroy();
  window.chartLinha = new Chart(ctxLinha, {
    type: "line",
    data: {
      labels: diasOrdenados,
      datasets: [{
        label: "Presen√ßas Confirmadas",
        data: presencaPorDia,
        backgroundColor: "#00509e33",
        borderColor: "#00509e",
        borderWidth: 2,
        fill: true
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero:true } }
    }
  });

  // Pizza: propor√ß√£o de status
  const statusCounts = { "Presen√ßa":0, "Fora do raio":0, "Email inv√°lido":0, "Duplicada":0 };
  filtrado.forEach(r => {
    if (r.presenca) statusCounts["Presen√ßa"]++;
    else statusCounts[statusMap[r.motivo] || "Duplicada"]++;
  });

  const ctxPizza = document.getElementById("graficoPizza").getContext("2d");
  if (window.chartPizza) window.chartPizza.destroy();
  window.chartPizza = new Chart(ctxPizza, {
    type: "pie",
    data: {
      labels: Object.keys(statusCounts),
      datasets: [{
        data: Object.values(statusCounts),
        backgroundColor: ["#00509e","#f03e3e","#f5c242","#6c757d"]
      }]
    },
    options: { responsive:false, maintainAspectRatio:true }
  });

  // Barra: estat√≠sticas b√°sicas
  const totalAlunos = alunos.length;
  const totalConfirmadas = filtrado.filter(r => r.presenca).length;
  const ctxBarra = document.getElementById("graficoBarra").getContext("2d");
  if (window.chartBarra) window.chartBarra.destroy();
  window.chartBarra = new Chart(ctxBarra, {
    type: "bar",
    data: {
      labels: ["Total de Alunos","Total Presen√ßas"],
      datasets: [{
        label: "Quantidade",
        data: [totalAlunos,totalConfirmadas],
        backgroundColor: ["#00509e","#28a745"]
      }]
    },
    options: { responsive:false, maintainAspectRatio:true, scales:{y:{beginAtZero:true}} }
  });
}

// ==============================
// Primeira renderiza√ß√£o
// ==============================

renderizar();
</script>

</body>
</html>
